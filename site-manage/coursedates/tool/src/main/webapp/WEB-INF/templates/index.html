<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	</head>
	<body class="portalBody Mrphs-portalBody Mrphs-sakai-coursedates-tool">
		<link media="all" href="/library/skin/tool_base.css" rel="stylesheet" type="text/css" />
		<link href="/library/skin/morpheus-default/tool.css" type="text/css" rel="stylesheet" media="all" />
		<script src="/library/js/headscripts.js" type="text/javascript"></script>
		<script th:inline="javascript">
			/*<![CDATA[*/
				var sakai = sakai || {}; sakai.editor = sakai.editor || {};
				sakai.locale = sakai.locale || {};
				sakai.locale.userCountry = [[${userCountry}]];
				sakai.locale.userLanguage = [[${userLanguage}]];
				sakai.locale.userLocale = [[${userLocale}]];
				includeLatestJQuery('coursedates/index.html');
			/*]]>*/
		</script>
		<script type="text/javascript" src="/library/js/lang-datepicker/lang-datepicker.js"></script>
		<meta http-equiv="Content-Style-Type" content="text/css" />
		<form class="panel-group" id="date-manager-form" method="POST">
			<div class="sak-banner-error hidden" id="form-errors">
				<span th:text="#{errors.instruction}">Your update could not be saved due to the following errors:</span>
				<ul></ul>
			</div>

			<div class="panel panel-default">
				<div class="panel-heading">
					<h4 class="panel-title">
						<a data-toggle="collapse" data-parent="#accordion" href="#collapse-assignments"><span th:text="#{tool.assignments.title}">Assignments</span></a>
					</h4>
				</div>
				<div id="collapse-assignments" class="panel-collapse collapse in">
					<div class="panel-body">
						<table class="table table-condensed table-striped table-bordered table-coursedates">
							<thead>
								<tr>
									<th th:text="#{column.title}">Title</th>
									<th th:text="#{column.start.date}">Start Date</th>
									<th th:text="#{column.start.due.date}">End/Due Date</th>
									<th th:text="#{column.accept.until.date}">Accept Until Date</th>
								</tr>
							</thead>
							<tbody>
								<th:block th:each="assignment, iter : ${assignments}">
									<tr>
										<td th:text="${assignment.title}">Assignment title</span>
										<td>
											<input type="text" class="form-control datepicker" />
											<input type="hidden" th:value="${assignment.open_date}" th:attr="data-idx=${iter.index}" data-field="open_date" data-tool="assignments" />
											<div><small class="text-muted day-of-week"></small></div>
											<div><small class="errors"></small></div>
										</td>
										<td>
											<input type="text" class="form-control datepicker" />
											<input type="hidden" th:value="${assignment.due_date}" th:attr="data-idx=${iter.index}" data-field="due_date" data-tool="assignments" />
											<div><small class="text-muted day-of-week"></small></div>
											<div><small class="errors"></small></div>
										</td>
										<td>
											<input type="text" class="form-control datepicker" />
											<input type="hidden" th:value="${assignment.accept_until}" th:attr="data-idx=${iter.index}" data-field="accept_until" data-tool="assignments" />
											<div><small class="text-muted day-of-week"></small></div>
											<div><small class="errors"></small></div>
										</td>
									</tr>
								</th:block>
							</tbody>
						</table>

					</div>
				</div>
			</div>

			<div class="act">
				<input type="submit" class="active" th:value="#{button.save}" id="submit-form-button" disabled="disabled" />
				<a href="#" id="coursedates-cancel" class="btn btn-default" th:text="#{button.cancel}">Cancel</a>
			</div>

			<div class="modal fade" tabindex="-1" role="dialog" aria-hidden="true" id="modal-confirm">
				<div class="modal-dialog modal-md">
					<div class="modal-content">
						<div class="modal-header">
							<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span class="fa fa-times" aria-hidden="true"></span></button>
							<h4 class="modal-title">Confirm</h4>
						</div>
						<div class="modal-body">
							<p th:text="#{modal.confirm.instruction}">You are about to modify the next course dates:</p>
							<ul id="modified-dates"></ul>
						</div>
						<div class="modal-footer act">
							<button type="button" class="active" id="modal-btn-confirm" th:text="#{button.save}">Save Changes</button>
							<button type="button" class="btn btn-default" id="modal-btn-cancel" th:text="#{button.cancel}">Cancel</button>
						</div>
					</div>
				</div>
			</div>
		</form>

		<script th:inline="javascript">
			/*<![CDATA[*/
				document.addEventListener("DOMContentLoaded", function(e) {
					var updates = [];
					updates.assignments = [];
					updates.assignmentsUpd = [];
					var errors = [];

					/*[# th:each="assignment : ${assignments}"]*/
						var assignmentJson = /*[[${assignment}]]*/;
						assignmentJson.open_date_day_of_week = undefined;
						assignmentJson.due_date_day_of_week = undefined;
						assignmentJson.accept_until_day_of_week = undefined;
						updates.assignments.push(assignmentJson);
					/*[/]*/

					var notModified = [];
					$('.datepicker').each(function (idx, elt) {
						var $td = $(elt).closest('td');
						var $hidden = $td.find('input:hidden');

						var dataTool = $hidden.data('tool');
						var dataField = $hidden.data('field');
						var dataIdx = $hidden.data('idx');
						$td.attr('id', 'cell_' + dataTool + '_' + dataField + '_' + dataIdx);

						$hidden.on('change', function () {
							var idx = $(this).data('idx');
							var field = $(this).data('field');
							var tool = $(this).data('tool');

							updates[tool][idx][field] = $(this).val().split('+')[0];
							updates[tool][idx][field + '_label'] = $(this).siblings('input.datepicker').val();
							updates[tool][idx][field + '_day_of_week'] = moment(updates[tool][idx][field]).format('dddd');
							$(this).parent().find('.day-of-week').text(updates[tool][idx][field + '_day_of_week']);

							if (notModified.includes(tool + idx + field)) {
								updates[tool][idx].idx = idx;
								updates[tool + 'Upd'][idx] = updates[tool][idx];
								$('#submit-form-button').prop('disabled', false);
							}
							notModified.push(tool + idx + field);
						});

						$hidden.attr('id', 'hidden_datepicker_' + idx);
						var datepickerOpts = {
							input: elt,
							useTime: 1,
							parseFormat: 'YYYY-MM-DD HH:mm:ss',
							allowEmptyDate: false,
							ashidden: {
								iso8601: 'hidden_datepicker_' + idx,
							}
						};
						if ($hidden.val() != '') datepickerOpts.val = $hidden.val();
						localDatePicker(datepickerOpts);
					});

					function printErrors() {
						$('.errors').empty();
						$('.ajax-error').removeClass('ajax-error');
						$('#form-errors').removeClass('hidden');
						$('#form-errors').find('ul').empty();
						$(errors).each(function (idx, elt) {
							var id = ['cell', elt.toolId, elt.field, elt.idx].join('_');
							var $cell = $('#' + id);
							$cell.addClass('ajax-error');
							$cell.find('.errors').text(elt.msg);
							$('#form-errors').find('ul').append('<li>' + elt.toolTitle + ' - ' + updates[elt.toolId][elt.idx].title + ' - ' + elt.msg + '</li>');
						});
					}

					var modalConfirm = function(callback){
						$('#date-manager-form').on("submit", function(e){
							e.preventDefault();
							$("#modal-confirm").modal('show');
							$('#modified-dates').empty();
							$.each([updates.assignmentsUpd.filter(el=>el)], function(idx, elt) {
								$.each(elt, function(idx, elt) {
									$('#modified-dates').append('<li>' + elt.tool_title + ' - ' + elt.title + '</li>');
								});
							});
						});

						$("#modal-btn-confirm").on("click", function(){
							callback(true);
							$("#modal-confirm").modal('hide');
						});

						$("#modal-btn-cancel").on("click", function(){
							callback(false);
							$("#modal-confirm").modal('hide');
						});
					};

					modalConfirm(function(confirm){
						if (confirm) confirmFormSubmit();
					});

					function confirmFormSubmit() {
						var $form = $('#date-manager-form');
						var formData = new FormData();
						var assignmentsStr = JSON.stringify(updates.assignmentsUpd.filter(el=>el));
						var json = '{"assignments": ' + assignmentsStr + '}';
						formData.append('json', json);

						$.ajax({
							url: window.location + '/date-manager/update',
							processData: false,
							contentType: false,
							cache: false,
							data: formData,
							method: $form.attr('method'),
							success: function(response){
								if (response.status === 'ERROR') {
									errors = response.errors;
									printErrors();
								} else window.location.reload();
							}
						});
					}

					$('#coursedates-cancel').click(function(e) {
						e.preventDefault;
						window.location = window.location.href.replace('/sakai.coursedates.helper', '');
					});
				});
			/*]]>*/
		</script>
	</body>
</html>
